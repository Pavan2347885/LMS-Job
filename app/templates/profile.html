{% extends 'base1.html' %}
{% load static %}

{% block head %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Profile | Job Portal</title>
    <link rel="stylesheet" href="{% static 'css/styleprofile.css' %}">
    <!-- Bootstrap CSS -->
   
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>/* Navbar Styles */
        .navbar {
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 0.8rem 1rem;
        }
        
        .navbar-brand {
            font-weight: 700;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }
        
        .navbar-brand .logo-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
            color: #3498db;
        }
        
        .navbar-toggler {
            border: none;
            padding: 0.5rem;
        }
        
        .navbar-toggler:focus {
            outline: none;
            box-shadow: none;
        }
        
        .navbar-toggler-icon {
            background-image: none;
            width: 1.5em;
            height: 1.5em;
            position: relative;
        }
        
        .navbar-toggler-icon::before,
        .navbar-toggler-icon::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #2c3e50;
            transition: all 0.3s ease;
        }
        
        .navbar-toggler-icon::before {
            top: 6px;
        }
        
        .navbar-toggler-icon::after {
            bottom: 6px;
        }
        
        .navbar-toggler[aria-expanded="true"] .navbar-toggler-icon::before {
            transform: rotate(45deg);
            top: 10px;
        }
        
        .navbar-toggler[aria-expanded="true"] .navbar-toggler-icon::after {
            transform: rotate(-45deg);
            bottom: 10px;
        }
        
        .nav-link {
            color: #2c3e50;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }
        
        .nav-link:hover,
        .nav-link:focus {
            color: #3498db;
        }
        
        .profile-icon {
            font-size: 1.1rem;
        }
        
        .btn-outline-light {
            border-color: #3498db;
            color: #3498db;
        }
        
        .btn-outline-light:hover {
            background-color: #3498db;
            color: white;
        }
        
        .btn-light {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .btn-light:hover {
            background-color: #2980b9;
            border-color: #2980b9;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            border-color: #e74c3c;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
            border-color: #c0392b;
        }
        
        /* Mobile menu styles */
        @media (max-width: 991.98px) {
            .navbar-collapse {
                padding: 1rem;
                background-color: #fff;
                box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
                margin-top: 0.5rem;
                border-radius: 0.25rem;
            }
            
            .nav-item {
                margin-bottom: 0.5rem;
            }
            
            .nav-link {
                padding: 0.5rem 0;
            }
            
            .navbar-nav .btn {
                width: 100%;
                margin-top: 0.5rem;
            }
            
            .d-flex.flex-column.flex-lg-row {
                width: 100%;
            }
        }
        
        /* Desktop menu styles */
        @media (min-width: 992px) {
            .navbar-nav {
                align-items: center;
            }
            
            .nav-item {
                margin-left: 0.5rem;
                margin-right: 0.5rem;
            }
            
            .navbar-nav .btn {
                margin-right: 0.5rem;
            }
          
        }/* Footer */
        footer {
            background-color: #343a40;
            color: white;
            padding: 3rem 0;
            margin-top: auto;
            width: 100%;
        }
        
        .footer-links {
            list-style: none;
            padding: 0;
        }
        
        .footer-links li {
            margin-bottom: 0.5rem;
        }
        
        .footer-links a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .footer-links a:hover {
            color: white;
        }
        
        .social-icons a {
            color: white;
            font-size: 1.25rem;
            margin-right: 1rem;
            transition: transform 0.3s ease;
        }
        
        .social-icons a:hover {
            transform: translateY(-3px);
        }
    </style>
    {% endblock %}

    {% block content %}
    <!-- Work Experience Template (hidden by default) -->
    <div id="experience-template" class="d-none">
        <div class="card-custom experience-item mb-3" data-id="">
            <div class="card-header-custom d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-briefcase mr-2"></i>
                    <span class="company-name"></span>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary edit-experience">
                        <i class="fas fa-pen"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-experience">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
            <div class="card-body-custom">
                <h6 class="job-title"></h6>
                <p class="text-muted experience-dates"></p>
                <p class="job-description"></p>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Alert for notifications -->
        <div id="alert-container"></div>
        
        <div class="row">
            <!-- Sidebar Navigation -->
            <div class="col-lg-3">
                <div class="profile-nav">
                    <div class="sidebar-box">
                        <h5 class="mb-3">Profile Sections</h5>
                        <nav class="nav flex-column">
                            <a class="nav-link active" href="#personal-info-section">
                                <i class="fas fa-user"></i> Personal Info
                            </a>
                            <a class="nav-link" href="#education-section">
                                <i class="fas fa-graduation-cap"></i> Education
                            </a>
                            <a class="nav-link" href="#experience-section">
                                <i class="fas fa-briefcase"></i> Experience
                            </a>
                            <a class="nav-link" href="#skills-section">
                                <i class="fas fa-code"></i> Skills
                            </a>
                            <a class="nav-link" href="#projects-section">
                                <i class="fas fa-project-diagram"></i> Projects
                            </a>
                        </nav>
                    </div>

                    <!-- Resume Section -->
                    <div class="sidebar-box">
                        <h5 class="mb-3">Resume</h5>
                        <div class="resume-actions">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <i class="fas fa-file-alt fa-2x text-primary"></i>
                                </div>
                                <div>
                                    {% comment %} <a href="#" class="btn btn-sm btn-outline-primary" id="download-resume">
                                        <i class="fas fa-download mr-1"></i> Download
                                    </a> {% endcomment %}
                                </div>
                            </div>
                            <p class="mb-2 small" id="resume-filename">No resume uploaded</p>
                            <p class="mb-0 small text-muted" id="resume-updated">Upload your resume to increase profile visibility</p>
                        </div>
                        <div class="mt-3">
                            <label for="resume-upload" class="btn btn-outline-primary btn-block">
                                <i class="fas fa-upload mr-1"></i> Upload New Resume
                            </label>
                            <input type="file" id="resume-upload" class="file-input-hidden" accept=".pdf,.doc,.docx">
                        </div>
                    </div>
                    <!-- Add this to your HTML where you want the resume generation options -->
<div class="sidebar-box">
    <h5 class="mb-3">Generate Resume</h5>
    <div class="resume-templates">
        <div class="row">
            <div class="col-6 mb-3">
                {% load static%}
                <div class="template-preview" data-template="1">
                    <img src="{% static 'images/download1.jpeg' %}" class="img-fluid">
                    <button class="btn btn-primary btn-sm btn-block mt-2 generate-resume-btn">Use Template 1</button>
                </div>
            </div>
            <div class="col-6 mb-3">
                {% load static%}
                <div class="template-preview" data-template="2">
                    <img src="{% static 'images/download2.jpeg' %}" class="img-fluid">
                    <button class="btn btn-primary btn-sm btn-block mt-2 generate-resume-btn">Use Template 2</button>
                </div>
            </div>
            <div class="col-6 mb-3">
                {% load static%}
                <div class="template-preview" data-template="3">
                    <img src="{% static 'images/download3.jpeg' %}" class="img-fluid">
                    <button class="btn btn-primary btn-sm btn-block mt-2 generate-resume-btn">Use Template 3</button>
                </div>
            </div>
            <div class="col-6 mb-3">
                {% load static%}
                <div class="template-preview" data-template="4">
                    <img src="{% static 'images/download4.jpeg' %}" class="img-fluid">
                    <button class="btn btn-primary btn-sm btn-block mt-2 generate-resume-btn">Use Template 4</button>
                </div>
            </div>
        </div>
    </div>
</div>

                    <!-- Profile Visibility -->
                    <div class="sidebar-box">
                        <h5 class="mb-3">Profile Visibility</h5>
                        <div class="custom-control custom-switch mb-3">
                            <input type="checkbox" class="custom-control-input" id="visibility-switch" checked>
                            <label class="custom-control-label" for="visibility-switch">
                                Visible to Recruiters
                            </label>
                        </div>
                        <p class="small text-muted mb-0">
                            When turned on, recruiters can find your profile and contact you with relevant job opportunities.
                        </p>
                    </div>

                    <!-- Activity Summary -->
                    <div class="sidebar-box">
                        <h5 class="mb-3">Activity Summary</h5>
                        <div class="mb-2">
                            <i class="fas fa-eye mr-2 text-primary"></i>
                            <span>Profile viewed by <strong>15</strong> recruiters</span>
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-paper-plane mr-2 text-primary"></i>
                            <span><strong>8</strong> job applications submitted</span>
                        </div>
                        <div>
                            <i class="fas fa-star mr-2 text-primary"></i>
                            <span><strong>5</strong> jobs saved</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Profile Completion -->
                <div class="profile-container">
                    <div class="profile-content">
                        <div class="profile-completion">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">Profile Completion</h5>
                                <span id="completion-percentage">70%</span>
                            </div>
                            <div class="progress">
                                <div class="progress-bar" role="progressbar" style="width: 70%"></div>
                            </div>
                            <div class="mt-2 text-muted small">
                                Complete your profile to attract more recruiters
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Personal Information -->
                <div class="profile-container" id="personal-info-section">
                    <span class="section-anchor" id="personal-info-anchor"></span>
                    <div class="profile-header">
                        <h5 class="mb-0">Personal Information</h5>
                    </div>
                    <div class="profile-content">
                        <form id="personal-info-form">
                            <div class="row">
                                <div class="col-md-4 text-center">
                                    <div class="profile-picture-container">
                                        <img id="profile-picture" src="/api/placeholder/150/150" alt="Profile Picture" class="profile-picture">
                                        <label for="profile-picture-input" class="edit-picture">
                                            <i class="fas fa-camera"></i>
                                        </label>
                                        <input type="file" id="profile-picture-input" class="file-input-hidden" accept="image/*" name="profile_picture">
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="form-group">
                                        <label for="username">Full Name</label>
                                        <input type="text" class="form-control" id="username" name="username">
                                    </div>
                                    <div class="form-group">
                                        <label for="email">Email</label>
                                        <input type="email" class="form-control" id="email" name="email">
                                    </div>
                                    <div class="form-group">
                                        <label for="father_name">Father's Name</label>
                                        <input type="text" class="form-control" id="father_name" name="father_name">
                                    </div>
                                    <div class="form-group">
                                        <label for="mobile">Mobile Number</label>
                                        <input type="text" class="form-control" id="mobile" name="mobile">
                                    </div>
                                    <div class="form-group">
                                        <label for="location">Current Location</label>
                                        <input type="text" class="form-control" id="location" name="location">
                                    </div>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Education Details -->
                <div class="profile-container" id="education-section">
                    <span class="section-anchor" id="education-anchor"></span>
                    <div class="profile-header">
                        <h5 class="mb-0">Education Details</h5>
                    </div>
                    <div class="profile-content">
                        <form id="education-form">
                            <div class="card-custom">
                                <div class="card-header-custom">
                                    <i class="fas fa-graduation-cap mr-2"></i> Graduation / Post Graduation
                                </div>
                                <div class="card-body-custom">
                                    <div class="form-group">
                                        <label for="ug_college">University/College</label>
                                        <input type="text" class="form-control" id="ug_college" name="ug_college">
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="branch">Course/Branch</label>
                                            <input type="text" class="form-control" id="branch" name="branch">
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="passout_year">Passout Year</label>
                                            <input type="text" class="form-control" id="passout_year" name="passout_year">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="graduation_percentage">Graduation Percentage/CGPA</label>
                                        <input type="text" class="form-control" id="graduation_percentage" name="graduation_percentage">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-custom">
                                <div class="card-header-custom">
                                    <i class="fas fa-school mr-2"></i> 12th Standard
                                </div>
                                <div class="card-body-custom">
                                    <div class="form-group">
                                        <label for="twelfth_school">School Name</label>
                                        <input type="text" class="form-control" id="twelfth_school" name="twelfth_school">
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="twelfth_board">Board</label>
                                            <input type="text" class="form-control" id="twelfth_board" name="twelfth_board">
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="twelfth_year">Passout Year</label>
                                            <input type="text" class="form-control" id="twelfth_year" name="twelfth_year">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="twelfth_percentage">Percentage</label>
                                        <input type="text" class="form-control" id="twelfth_percentage" name="twelfth_percentage">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card-custom">
                                <div class="card-header-custom">
                                    <i class="fas fa-school mr-2"></i> 10th Standard
                                </div>
                                <div class="card-body-custom">
                                    <div class="form-group">
                                        <label for="tenth_school">School Name</label>
                                        <input type="text" class="form-control" id="tenth_school" name="tenth_school">
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label for="tenth_board">Board</label>
                                            <input type="text" class="form-control" id="tenth_board" name="tenth_board">
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label for="tenth_year">Passout Year</label>
                                            <input type="text" class="form-control" id="tenth_year" name="tenth_year">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="tenth_percentage">Percentage</label>
                                        <input type="text" class="form-control" id="tenth_percentage" name="tenth_percentage">
                                    </div>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn btn-primary mt-3">Save Education Details</button>
                        </form>
                    </div>
                </div>

                <!-- Work Experience -->
                <div class="profile-container" id="experience-section">
                    <span class="section-anchor" id="experience-anchor"></span>
                    <div class="profile-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Work Experience</h5>
                        <button type="button" class="btn btn-sm btn-light" id="add-experience">
                            <i class="fas fa-plus"></i> Add Experience
                        </button>
                    </div>
                    <div class="profile-content">
                        <div id="experience-container">
                            <!-- Experience entries will be added here -->
                            <div class="text-center text-muted py-4" id="no-experience-message">
                                <i class="fas fa-briefcase fa-2x mb-2"></i>
                                <p>No work experience added yet</p>
                                <button class="btn btn-outline-primary btn-sm" id="add-first-experience">
                                    <i class="fas fa-plus"></i> Add Work Experience
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Skills -->
                <div class="profile-container" id="skills-section">
                    <span class="section-anchor" id="skills-anchor"></span>
                    <div class="profile-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Skills</h5>
                        <button type="button" class="btn btn-sm btn-light" id="add-skill-btn">
                            <i class="fas fa-plus"></i> Add Skill
                        </button>
                    </div>
                    <div class="profile-content">
                        <div id="skills-container" class="mb-3">
                            <!-- Skills will be dynamically added here -->
                        </div>
                        <div id="add-skill-form" class="d-none">
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="skill-input" placeholder="Add a skill (e.g., Java, Project Management)">
                                <div class="input-group-append">
                                    <button class="btn btn-outline-secondary" type="button" id="save-skill-btn">Add</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Projects -->
                <div class="profile-container" id="projects-section">
                    <span class="section-anchor" id="projects-anchor"></span>
                    <div class="profile-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Projects</h5>
                        <button type="button" class="btn btn-sm btn-light" id="add-project">
                            <i class="fas fa-plus"></i> Add Project
                        </button>
                    </div>
                    <div class="profile-content">
                        <div id="projects-container">
                            <!-- Projects will be added here -->
                            <div class="text-center text-muted py-4" id="no-projects-message">
                                <i class="fas fa-project-diagram fa-2x mb-2"></i>
                                <p>No projects added yet</p>
                                <button class="btn btn-outline-primary btn-sm" id="add-first-project">
                                    <i class="fas fa-plus"></i> Add Project
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Experience Modal -->
    <div class="modal fade" id="experience-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Work Experience</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="experience-form">
                        <input type="hidden" id="experience-id">
                        <div class="form-group">
                            <label for="company-name">Company Name</label>
                            <input type="text" class="form-control" id="company-name" required>
                        </div>
                        <div class="form-group">
                            <label for="job-title">Job Title</label>
                            <input type="text" class="form-control" id="job-title" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="start-date">Start Date</label>
                                <input type="month" class="form-control" id="start-date" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="end-date">End Date</label>
                                <input type="month" class="form-control" id="end-date">
                                <div class="custom-control custom-checkbox mt-2">
                                    <input type="checkbox" class="custom-control-input" id="current-job">
                                    <label class="custom-control-label" for="current-job">I currently work here</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="job-description">Job Description</label>
                            <textarea class="form-control" id="job-description" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-experience">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal fade" id="project-modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Project</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="project-form">
                        {% csrf_token %} 
                        <input type="hidden" id="project-id">
                        <div class="form-group">
                            <label for="project-title">Project Title</label>
                            <input type="text" class="form-control" id="project-title" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="project-start-date">Start Date</label>
                                <input type="month" class="form-control" id="project-start-date">
                            </div>
                            <div class="form-group col-md-6">
                                <label for="project-end-date">End Date</label>
                                <input type="month" class="form-control" id="project-end-date">
                                <div class="custom-control custom-checkbox mt-2">
                                    <input type="checkbox" class="custom-control-input" id="current-project">
                                    <label class="custom-control-label" for="current-project">Ongoing project</label>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="project-description">Project Description</label>
                            <textarea class="form-control" id="project-description" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="project-link">Project Link/URL (Optional)</label>
                            <input type="text" class="form-control" id="project-link">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="save-project" >Save</button>
                </div>
            </div>
        </div>
    </div>
    {% endblock %}

    {% block scripts %}
    <!-- Bootstrap JS and dependencies -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function() {
            // Fetch user profile data on page load
            $.ajax({
                url: '/get_user_profile/',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        const userData = response.data[0];
                        $('#username').val(userData.user_name);
                        $('#email').val(userData.email);
                        $('#father_name').val(userData.father_name);
                        $('#ug_college').val(userData.ug_college);
                        $('#branch').val(userData.branch);

                        $('#passout_year').val(userData.Passout_Year);
                        $('#graduation_percentage').val(userData.Graduation_Percentage);
                        $('#tenth_percentage').val(userData.Percentage_10);
                        $('#twelfth_percentage').val(userData.twelfth_percentage);
                        $('#mobile').val(userData.mobile);
                        $('#location').val(userData.location);
                        $('#tenth_school').val(userData.tenth_school);
                        $('#tenth_board').val(userData.tenth_board);  
                        $('#tenth_year').val(userData.tenth_year);
                        $('#twelfth_school').val(userData.twelfth_school);
                        $('#twelfth_board').val(userData.twelfth_board);
                        $('#twelfth_year').val(userData.twelfth_year);
                        
                        if (userData.profile_picture) {
                            $('#profile-picture').attr('src', 'data:image/jpeg;base64,' + userData.profile_picture);
                        }

                        calculateCompletionPercentage();
                    }
                }
            });

            // Handle form submission for personal information
            $('#personal-info-form').on('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                $.ajax({
                    url: '/update_profile/',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.status === 'success') {
                            alert('Profile updated successfully!');
                            location.reload(); // Reload the page to reflect changes
                        } else {
                            alert('Error updating profile: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error updating profile: ' + error);
                    }
                });
            });

            // Handle form submission for education details
            $('#education-form').on('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                $.ajax({
                    url: '/update_profile/',
                    method: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        if (response.status === 'success') {
                            alert('Education details updated successfully!');
                            location.reload(); // Reload the page to reflect changes
                        } else {
                            alert('Error updating education details: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('Error updating education details: ' + error);
                    }
                });
            });
        });
        $(document).ready(function() {
          // Function to calculate profile completion percentage
          function calculateCompletionPercentage() {
              let filledFields = 0;
              // List all the fields you want to include in the calculation
              const fields = [
                  '#username', '#email', '#father_name', '#ug_college', '#branch',
                  '#passout_year', '#graduation_percentage', '#tenth_percentage',
                  '#twelfth_percentage', '#mobile', '#location', '#tenth_school',
                  '#tenth_board', '#tenth_year', '#twelfth_school', '#twelfth_board',
                  '#twelfth_year'
              ];
              const totalFields = fields.length;
      
              // Check each field to see if it's filled (excluding "N/A" and empty strings)
              fields.forEach(function(field) {
                  const value = $(field).val().trim();
                  if (value !== '' && value !== 'N/A') {
                      filledFields++;
                  }
              });
      
              // Calculate percentage and ensure it does not exceed 100%
              let completionPercentage = Math.round((filledFields / totalFields) * 100);
              completionPercentage = Math.min(completionPercentage, 100); // Cap at 100%
      
              // Update the percentage text and progress bar width
              $('#completion-percentage').text(completionPercentage + "%");
              $('.progress-bar').css('width', completionPercentage + '%');
      
              console.log("Filled Fields:", filledFields);
              console.log("Total Fields:", totalFields);
              console.log("Completion Percentage:", completionPercentage);
          }
      
          // Fetch user profile data on page load
          $.ajax({
              url: '/get_user_profile/',
              method: 'GET',
              success: function(response) {
                  if (response.success) {
                      const userData = response.data[0];
                      $('#username').val(userData.user_name);
                      $('#email').val(userData.email);
                      $('#father_name').val(userData.father_name);
                      $('#ug_college').val(userData.ug_college);
                      $('#branch').val(userData.branch);
                      $('#passout_year').val(userData.Passout_Year);
                      $('#graduation_percentage').val(userData.Graduation_Percentage);
                      $('#tenth_percentage').val(userData.Percentage_10);
                      $('#twelfth_percentage').val(userData.twelfth_percentage);
                      $('#mobile').val(userData.mobile);
                      $('#location').val(userData.location);
                      $('#tenth_school').val(userData.tenth_school);
                      $('#tenth_board').val(userData.tenth_board);
                      $('#tenth_year').val(userData.tenth_year);
                      $('#twelfth_school').val(userData.twelfth_school);
                      $('#twelfth_board').val(userData.twelfth_board);
                      $('#twelfth_year').val(userData.twelfth_year);
      
                      if (userData.profile_picture) {
                          $('#profile-picture').attr('src', 'data:image/jpeg;base64,' + userData.profile_picture);
                      }
      
                      // Calculate and display the profile completion percentage
                      calculateCompletionPercentage();
                  }
              }
          });
      
          // Recalculate the completion percentage whenever an input field changes
          $('input[type="text"], input[type="email"], input[type="number"]').on('input', calculateCompletionPercentage);
      });
      $(document).ready(function() {
        // Fetch user profile data on page load
        $.ajax({
            url: '/get_user_profile/',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const userData = response.data[0];
                    // Populate other fields as before...
    
                    // Populate skills
                    const skillsContainer = $('#skills-container');
                    skillsContainer.empty();
                    userData.skills.forEach(skill => {
                        skillsContainer.append(`
                            <div class="skill-badge">${skill} <i class="fas fa-times-circle ml-1 text-muted remove-skill"></i></div>
                        `);
                    });
                }
            }
        });
    
        // Show add skill form
        $('#add-skill-btn').click(function() {
            $('#add-skill-form').removeClass('d-none');
        });
    
        // Add skill
        $('#save-skill-btn').click(function() {
            const skill = $('#skill-input').val().trim();
            if (skill) {
                $.ajax({
                    url: '/add_skill/',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ skill: skill }),
                    success: function(response) {
                        if (response.success) {
                            $('#skills-container').append(`
                                <div class="skill-badge">${skill} <i class="fas fa-times-circle ml-1 text-muted remove-skill"></i></div>
                            `);
                            $('#skill-input').val('');
                            $('#add-skill-form').addClass('d-none');
                        }
                    }
                });
            }
        });
    
        // Remove skill
        $(document).on('click', '.remove-skill', function() {
            const skillBadge = $(this).closest('.skill-badge');
            const skill = skillBadge.text().trim();
            $.ajax({
                url: '/remove_skill/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ skill: skill }),
                success: function(response) {
                    if (response.success) {
                        skillBadge.remove();
                    }
                }
            });
        });
    });
{% comment %} projects {% endcomment %}
$(document).ready(function () {
    const userId = "{{ request.user.id }}"; // Replace with your user ID retrieval logic

    // Fetch and display projects
    function fetchProjects() {
        $.ajax({
            url: '/get_projects/',
            method: 'GET',
            data: { user_id: userId },
            success: function (response) {
                if (response.success) {
                    const projects = response.data;
                    $('#projects-container').empty();
                    if (projects.length > 0) {
                        projects.forEach(project => {
                            const projectItem = `
                                <div class="project-item mb-3 p-3 border rounded" data-id="${project._id}">
                                    <h6>${project.title}</h6>
                                    <p class="text-muted">${project.description}</p>
                                    <small class="d-block mb-2">${formatProjectDate(project.start_date)} - ${project.end_date ? formatProjectDate(project.end_date) : 'Present'}</small>
                                    ${project.link ? `<a href="${project.link}" target="_blank" class="d-block mb-2">View Project</a>` : ''}
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary edit-project" data-project-id="${project.title}" value="${project._id}">Edit</button>
                                        <button class="btn btn-sm btn-outline-danger delete-project" data-project-id="${project.title}">Delete</button>
                                    </div>
                                </div>
                            `;
                            $('#projects-container').append(projectItem);
                        });
                        $('#no-projects-message').hide();
                    } else {
                        $('#no-projects-message').show();
                    }
                }
            }
        });
    }

    // Format date for display
    function formatProjectDate(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short' 
        });
    }

   
    
   
   
    

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

    // Helper function to show alerts
    function showAlert(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        `;
        $('#alert-container').html(alertHtml);
        setTimeout(() => {
            $('.alert').alert('close');
        }, 5000);
    }

    // Initial fetch of projects
    fetchProjects();
});
$(document).ready(function() {
    // Fetch and display resume info on page load
    function fetchResumeInfo() {
        $.ajax({
            url: '/get_resume/',
            method: 'GET',
            success: function(response) {
                if (response.success && response.resume) {
                    $('#resume-filename').text(response.resume.filename);
                    $('#resume-updated').text('Last updated: ' + formatDate(response.resume.updated_at));
                    $('#download-resume').attr('href', '/download_resume/');
                } else {
                    $('#resume-filename').text('No resume uploaded');
                    $('#resume-updated').text('Upload your resume to increase profile visibility');
                    $('#download-resume').attr('href', '#');
                }
            }
        });
    }

    // Format date for display
    function formatDate(timestamp) {
        if (!timestamp) return '';
        const date = new Date(timestamp);
        return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric' 
        });
    }

    // Handle resume upload
    $('#resume-upload').on('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Validate file type
        const allowedTypes = ['application/pdf', 'application/msword', 
                             'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
        if (!allowedTypes.includes(file.type)) {
            showAlert('error', 'Only PDF and Word documents are allowed.');
            return;
        }

        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
            showAlert('error', 'File size should be less than 5MB.');
            return;
        }

        const formData = new FormData();
        formData.append('resume', file);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        $.ajax({
            url: '/upload_resume/',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    showAlert('success', 'Resume uploaded successfully!');
                    fetchResumeInfo();
                    // Recalculate profile completion
                    calculateCompletionPercentage();
                } else {
                    showAlert('error', response.message || 'Error uploading resume');
                }
            },
            error: function(xhr) {
                showAlert('error', 'Error uploading resume: ' + xhr.responseText);
            }
        });
    });

    // Helper function to show alerts
    function showAlert(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        `;
        $('#alert-container').html(alertHtml);
        setTimeout(() => {
            $('.alert').alert('close');
        }, 5000);
    }

    // Initial fetch of resume info
    fetchResumeInfo();
});
$(document).ready(function() {
    // Fetch and display experiences on page load
    function fetchExperiences() {
        $.ajax({
            url: '/get_experiences/',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const experiences = response.data;
                    const container = $('#experience-container');
                    container.empty();
                    
                    if (experiences.length > 0) {
                        $('#no-experience-message').hide();
                        experiences.forEach(exp => {
                            addExperienceToDOM(exp);
                        });
                    } else {
                        $('#no-experience-message').show();
                    }
                }
            },
            error: function(xhr, status, error) {
                showAlert('error', 'Failed to load experiences: ' + error);
            }
        });
    }

    // Add experience to DOM
    function addExperienceToDOM(experience) {
        const template = $('#experience-template').clone();
        const experienceItem = template.removeClass('d-none');
        
        experienceItem.attr('data-id', experience._id);
        experienceItem.find('.company-name').text(experience.company_name);
        experienceItem.find('.job-title').text(experience.job_title);
        
        // Format dates
        const startDate = formatDate(experience.start_date);
        let endDate = experience.currently_working ? 'Present' : 
                     (experience.end_date ? formatDate(experience.end_date) : 'Not specified');
        
        experienceItem.find('.experience-dates').text(`${startDate} - ${endDate}`);
        experienceItem.find('.job-description').text(experience.description || 'No description provided');
        
        // Add edit and delete handlers
        experienceItem.find('.edit-experience').data('experience-id', experience._id);
        experienceItem.find('.delete-experience').data('experience-id', experience._id);
        
        $('#experience-container').append(experienceItem);
    }

    // Format date for display
    function formatDate(dateString) {
        if (!dateString) return 'Not specified';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short' 
        });
    }

    // Open modal to add/edit experience
    function openExperienceModal(experience = null) {
        const modal = $('#experience-modal');
        
        if (experience) {
            // Edit mode
            modal.find('.modal-title').text('Edit Work Experience');
            $('#experience-id').val(experience._id);
            $('#company-name').val(experience.company_name);
            $('#job-title').val(experience.job_title);
            $('#start-date').val(experience.start_date.substring(0, 7)); // Format as YYYY-MM
            $('#end-date').val(experience.end_date ? experience.end_date.substring(0, 7) : '');
            $('#current-job').prop('checked', experience.currently_working);
            $('#job-description').val(experience.description || '');
            
            // Disable end date if currently working
            if (experience.currently_working) {
                $('#end-date').prop('disabled', true);
            }
        } else {
            // Add mode
            modal.find('.modal-title').text('Add Work Experience');
            $('#experience-form')[0].reset();
            $('#experience-id').val('');
            $('#current-job').prop('checked', false);
            $('#end-date').prop('disabled', false);
        }
        
        modal.modal('show');
    }

    // Handle "I currently work here" checkbox
    $('#current-job').change(function() {
        if ($(this).is(':checked')) {
            $('#end-date').val('').prop('disabled', true);
        } else {
            $('#end-date').prop('disabled', false);
        }
    });

    // Handle add experience buttons
    $('#add-experience, #add-first-experience').click(function() {
        openExperienceModal();
    });

    // Handle edit experience
    $(document).on('click', '.edit-experience', function() {
        const experienceId = $(this).data('experience-id');
        
        $.ajax({
            url: '/get_experiences/',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const experience = response.data.find(exp => exp._id === experienceId);
                    if (experience) {
                        openExperienceModal(experience);
                    }
                }
            },
            error: function(xhr, status, error) {
                showAlert('error', 'Failed to load experience: ' + error);
            }
        });
    });

    // Handle save experience
    $('#save-experience').click(function() {
        const experienceId = $('#experience-id').val();
        const isEdit = !!experienceId;
        
        const experienceData = {
            company_name: $('#company-name').val().trim(),
            job_title: $('#job-title').val().trim(),
            start_date: $('#start-date').val() + '-01', // Add day to make it valid date
            end_date: $('#current-job').is(':checked') ? null : ($('#end-date').val() ? $('#end-date').val() + '-01' : null),
            currently_working: $('#current-job').is(':checked'),
            description: $('#job-description').val().trim()
        };

        // Validate required fields
        if (!experienceData.company_name || !experienceData.job_title || !experienceData.start_date) {
            showAlert('error', 'Please fill in all required fields');
            return;
        }

        const url = isEdit ? '/update_experience/' : '/add_experience/';
        const method = isEdit ? 'PUT' : 'POST';
        
        if (isEdit) {
            experienceData.experience_id = experienceId;
        }

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(experienceData),
            success: function(response) {
                if (response.success) {
                    $('#experience-modal').modal('hide');
                    fetchExperiences();
                    showAlert('success', isEdit ? 'Experience updated successfully!' : 'Experience added successfully!');
                } else {
                    showAlert('error', response.error || 'An error occurred');
                }
            },
            error: function(xhr, status, error) {
                showAlert('error', 'Error: ' + error);
            }
        });
    });

    // Handle delete experience
    $(document).on('click', '.delete-experience', function() {
        const experienceId = $(this).data('experience-id');
        
        if (confirm('Are you sure you want to delete this experience?')) {
            $.ajax({
                url: '/delete_experience/',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ experience_id: experienceId }),
                success: function(response) {
                    if (response.success) {
                        fetchExperiences();
                        showAlert('success', 'Experience deleted successfully!');
                    } else {
                        showAlert('error', response.error || 'Failed to delete experience');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('error', 'Error: ' + error);
                }
            });
        }
    });

    // Helper function to show alerts
    function showAlert(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
        `;
        $('#alert-container').html(alertHtml);
        setTimeout(() => {
            $('.alert').alert('close');
        }, 5000);
    }

    // Initial fetch of experiences
    fetchExperiences();
});

$(document).ready(function() {
    // Fetch and display projects on page load
    function fetchProjects() {
        $.ajax({
            url: '/get_projects/',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const projects = response.data;
                    const container = $('#projects-container');
                    container.empty();
                    
                    if (projects.length > 0) {
                        $('#no-projects-message').hide();
                        projects.forEach(project => {
                            addProjectToDOM(project);
                        });
                    } else {
                        $('#no-projects-message').show();
                    }
                }
            },
            error: function(xhr, status, error) {
                showAlert('error', 'Failed to load projects: ' + error);
            }
        });
    }

    // Add project to DOM
    function addProjectToDOM(project) {
        const projectItem = $('<div class="card-custom project-item mb-3" data-id="' + project._id + '"></div>');
        
        const cardHeader = $(`
            <div class="card-header-custom d-flex justify-content-between align-items-center">
                <div>
                    <i class="fas fa-project-diagram mr-2"></i>
                    <span class="project-title">${project.title}</span>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary edit-project" data-project-id="${project._id}">
                        <i class="fas fa-pen"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-project" data-project-id="${project._id}">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        `);
        
        const cardBody = $(`<div class="card-body-custom"></div>`);
        cardBody.append(`<p class="project-description">${project.description || 'No description provided'}</p>`);
        
        // Format dates
        const startDate = formatDate(project.start_date);
        let endDate = project.currently_ongoing ? 'Present' : 
                     (project.end_date ? formatDate(project.end_date) : 'Not specified');
        
        cardBody.append(`<small class="d-block text-muted mb-2">${startDate} - ${endDate}</small>`);
        
        if (project.link) {
            cardBody.append(`<a href="${project.link}" target="_blank" class="d-block">View Project</a>`);
        }
        
        projectItem.append(cardHeader);
        projectItem.append(cardBody);
        $('#projects-container').append(projectItem);
    }

    // Format date for display
    function formatDate(dateString) {
        if (!dateString) return 'Not specified';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short' 
        });
    }

    // Open modal to add/edit project
    function openProjectModal(project = null) {
        const modal = $('#project-modal');
        
        if (project) {
            // Edit mode
            modal.find('.modal-title').text('Edit Project');
            $('#project-id').val(project._id);
            $('#project-title').val(project.title);
            $('#project-description').val(project.description || '');
            $('#project-start-date').val(project.start_date.substring(0, 7)); // Format as YYYY-MM
            $('#project-end-date').val(project.end_date ? project.end_date.substring(0, 7) : '');
            $('#current-project').prop('checked', project.currently_ongoing);
            $('#project-link').val(project.link || '');
            
            // Disable end date if currently ongoing
            if (project.currently_ongoing) {
                $('#project-end-date').prop('disabled', true);
            }
        } else {
            // Add mode
            modal.find('.modal-title').text('Add Project');
            $('#project-form')[0].reset();
            $('#project-id').val('');
            $('#current-project').prop('checked', false);
            $('#project-end-date').prop('disabled', false);
        }
        
        modal.modal('show');
    }

    // Handle "Ongoing project" checkbox
    $('#current-project').change(function() {
        if ($(this).is(':checked')) {
            $('#project-end-date').val('').prop('disabled', true);
        } else {
            $('#project-end-date').prop('disabled', false);
        }
    });

    // Handle add project buttons
    $('#add-project, #add-first-project').click(function() {
        openProjectModal();
    });

    // Handle edit project
    $(document).on('click', '.edit-project', function() {
        const projectId = $(this).data('project-id');
        
        $.ajax({
            url: '/get_projects/',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const project = response.data.find(proj => proj._id === projectId);
                    if (project) {
                        openProjectModal(project);
                    }
                }
            },
            error: function(xhr, status, error) {
                showAlert('error', 'Failed to load project: ' + error);
            }
        });
    });

    // Handle save project
    $('#save-project').click(function() {
        const projectId = $('#project-id').val();
        const isEdit = !!projectId;
        
        const projectData = {
            title: $('#project-title').val().trim(),
            description: $('#project-description').val().trim(),
            start_date: $('#project-start-date').val() + '-01', // Add day to make it valid date
            end_date: $('#current-project').is(':checked') ? null : ($('#project-end-date').val() ? $('#project-end-date').val() + '-01' : null),
            currently_ongoing: $('#current-project').is(':checked'),
            link: $('#project-link').val().trim()
        };

        // Validate required fields
        if (!projectData.title || !projectData.start_date) {
            showAlert('error', 'Please fill in all required fields');
            return;
        }

        const url = isEdit ? '/update_project/' : '/add_project/';
        const method = isEdit ? 'PUT' : 'POST';
        
        if (isEdit) {
            projectData.project_id = projectId;
        }

        $.ajax({
            url: url,
            method: method,
            contentType: 'application/json',
            data: JSON.stringify(projectData),
            success: function(response) {
                if (response.success) {
                    $('#project-modal').modal('hide');
                    fetchProjects();
                    showAlert('success', isEdit ? 'Project updated successfully!' : 'Project added successfully!');
                } else {
                    showAlert('error', response.error || 'An error occurred');
                }
            },
            error: function(xhr, status, error) {
                showAlert('error', 'Error: ' + error);
            }
        });
    });

    // Handle delete project
    $(document).on('click', '.delete-project', function() {
        const projectId = $(this).data('project-id');
        
        if (confirm('Are you sure you want to delete this project?')) {
            $.ajax({
                url: '/delete_project/',
                method: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify({ project_id: projectId }),
                success: function(response) {
                    if (response.success) {
                        fetchProjects();
                        showAlert('success', 'Project deleted successfully!');
                    } else {
                        showAlert('error', response.error || 'Failed to delete project');
                    }
                },
                error: function(xhr, status, error) {
                    showAlert('error', 'Error: ' + error);
                }
            });
        }
    });

    // Initial fetch of projects
    fetchProjects();
});
// Resume Generation with jsPDF
function generateResumeWithJsPDF(templateId, userData) {
    // Initialize jsPDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Set document properties
    doc.setProperties({
        title: `${userData.user_name}'s Resume`,
        subject: 'Professional Resume',
        author: userData.user_name,
        creator: 'Job Portal'
    });
     console.log(templateId);
    // Add content based on template
    switch(templateId.toString()) {
        case '1':
            generateTemplate1(doc, userData);
            break;
        case '2':
            generateTemplate2(doc, userData);
            break;
        case '3':
            generateTemplate3(doc, userData);
            break;
        case '4':
            generateTemplate4(doc, userData);
            break;
        default:
            console.error('Invalid template ID:', templateId);
            alert('Invalid template selected. Please try again.');
            return;
    }
    
    // Save the PDF
    doc.save(`${userData.user_name}_Resume_Template_${templateId}.pdf`);
}

// Helper function to format dates
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
        year: 'numeric', 
        month: 'short' 
    });
}


// Template 1 - Exact ATS Bold Accounting Resume Format
function generateTemplate1(doc, userData) {
    // Document setup - A4 size
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 20;
    const contentWidth = pageWidth - (margin * 2);
    
    // Set document properties with keywords for ATS
    doc.setProperties({
        title: `${userData.user_name} - Professional Resume`,
        subject: `Resume - ${userData.skills.slice(0, 5).join(', ')}`,
        author: userData.user_name,
        keywords: userData.skills.join(', ') // Keywords help with ATS scanning
    });

    // ===== HEADER SECTION =====
    // User name
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.setTextColor(0, 0, 0);
    doc.text(userData.user_name, margin, 25);
    
    // Main table structure starts
    let currentY = 32;
    
    // =====  CONTACT INFO & SUMMARY BOX =====
    // Create the contact info + summary table (exact table layout from sample)
    const tableWidth = contentWidth;
    const tableTop = currentY;
    
    // Draw outer table borders
    doc.setDrawColor(0);
    doc.setLineWidth(0.5);
    doc.rect(margin, tableTop, tableWidth, 80); // Height based on sample
    
    // Divide into two columns - 2/3 and 1/3
    const leftColWidth = tableWidth * 0.6;
    const rightColWidth = tableWidth * 0.4;
    
    // Draw vertical divider
    doc.line(margin + leftColWidth, tableTop, margin + leftColWidth, tableTop + 80);
    
    // Left column content - contact info
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    const contactInfo = [
        `${userData.location || '4567 Main Street, Detroit, MI 48127'} |`,
        `${userData.mobile || '(313) 555-0100'} |`,
        `${userData.email || '<donna@example.com>'} |`,
        `${userData.linkedin || 'www.greatsiteaddress.com'}`
    ];
    
    // Add contact info text with exact formatting
    doc.text(contactInfo, margin + 5, tableTop + 15);
    
    // Add summary text (if available)
    const summary = userData.summary || 
        "Analytical, organized and detail-oriented accountant with GAAP expertise and experience in the full spectrum of public accounting. Collaborative team player with ownership mentality and a track record of delivering the highest quality strategic solutions to resolve challenges and propel business growth.";
    
    const summaryLines = doc.splitTextToSize(summary, leftColWidth - 10);
    doc.text(summaryLines, margin + 5, tableTop + 30);
    
    // ===== HORIZONTAL DIVIDER =====
    // Add space after the first table
    currentY = tableTop + 80 + 15;
    
    // ===== EXPERIENCE SECTION =====
    // Create experience header table
    doc.setDrawColor(0);
    doc.rect(margin, currentY, tableWidth, 20);
    doc.line(margin + leftColWidth, currentY, margin + leftColWidth, currentY + 20);
    
    // Add experience heading
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text("ExperiEnce", margin + 5, currentY + 13);
    
    currentY += 20 + 15; // Move to after the header
    
    // Create space for experiences
    if (userData.experiences && userData.experiences.length > 0) {
        userData.experiences.forEach((exp, index) => {
            // Check if we need a new page
            if (currentY > pageHeight - 50) {
                doc.addPage();
                currentY = margin + 20;
            }
            
            // Date range 
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            const dateText = exp.currently_working ? 
                `${formatDate(exp.start_date)} -- Present` : 
                `${formatDate(exp.start_date)} -- ${formatDate(exp.end_date)}`;
                
            // Use the sample formatting with 20XX
            const formattedDateText = dateText.replace(/\d{4}/g, '20XX');
            doc.text(formattedDateText, margin, currentY);
            currentY += 8;
            
            // Job title and company
            doc.setFont("helvetica", "bold");
            const jobLine = `${exp.job_title || 'Accountant'} | ${exp.company_name || 'Company Name'} | ${exp.location || 'Location'}`;
            doc.text(jobLine, margin, currentY);
            currentY += 8;
            
            // Description paragraph
            doc.setFont("helvetica", "normal");
            const description = exp.description || "Description of job responsibilities and achievements.";
            const descLines = doc.splitTextToSize(description, contentWidth - 10);
            doc.text(descLines, margin, currentY);
            currentY += descLines.length * 5 + 15; // Space after description
        });
    } else {
        // Sample experience data if none provided
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text("20XX -- Present", margin, currentY);
        currentY += 8;
        
        doc.setFont("helvetica", "bold");
        doc.text("Accountant | Trey Research | San Francisco, CA", margin, currentY);
        currentY += 8;
        
        doc.setFont("helvetica", "normal");
        const sampleDesc = "Working in a mid-sized public accounting firm to provide professional accounting services for individuals and business clients. Provide full range of services, include income tax preparation, audit support, preparation of financial statements, pro forma budgeting, general ledger accounting, and bank reconciliation.";
        const sampleLines = doc.splitTextToSize(sampleDesc, contentWidth - 10);
        doc.text(sampleLines, margin, currentY);
        currentY += sampleLines.length * 5 + 15;
        
        // Second sample experience
        doc.text("20XX -- 20XX", margin, currentY);
        currentY += 8;
        
        doc.setFont("helvetica", "bold");
        doc.text("Bookkeeper | Bandter Real Estate | Berkeley, CA", margin, currentY);
        currentY += 8;
        
        doc.setFont("helvetica", "normal");
        const sampleDesc2 = "Inhouse bookkeeper for a real estate development company. Maintained financial books, tracked expenses, prepared, and submitted invoices, and oversaw payroll.";
        const sampleLines2 = doc.splitTextToSize(sampleDesc2, contentWidth - 10);
        doc.text(sampleLines2, margin, currentY);
        currentY += sampleLines2.length * 5 + 15;
        
        // Third sample experience with bold date
        doc.setFont("helvetica", "bold");
        doc.text("December 20XX -- April 20XX", margin, currentY);
        currentY += 8;
        
        doc.text("Accounting Intern | Olson Harris Ltd. | Vallejo, CA", margin, currentY);
        currentY += 8;
        
        doc.setFont("helvetica", "normal");
        const sampleDesc3 = "Assisted with payroll and Pensions service management for 150+ employees. Prepared invoices for more than 200 clients. Assisted with bill payments, records organization and preparation, and other office duties to support financial and accounting operations.";
        const sampleLines3 = doc.splitTextToSize(sampleDesc3, contentWidth - 10);
        doc.text(sampleLines3, margin, currentY);
        currentY += sampleLines3.length * 5 + 15;
    }
    
    // ===== EDUCATION SECTION =====
    // Check if we need a new page
    if (currentY > pageHeight - 100) {
        doc.addPage();
        currentY = margin + 20;
    }
    
    // Education header table
    doc.setDrawColor(0);
    doc.rect(margin, currentY, tableWidth, 20);
    doc.line(margin + leftColWidth, currentY, margin + leftColWidth, currentY + 20);
    
    // Add education heading
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text("Education", margin + 5, currentY + 13);
    
    currentY += 20 + 15; // Move to after header
    
    // Education content
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    
    // Add graduation date
    doc.text("June 20XX", margin, currentY);
    currentY += 8;
    
    // Add degree info
    doc.setFont("helvetica", "bold");
    const degreeText = "Bachelor of Science in Accounting, Minor in Business Administration | Bellows College";
    doc.text(degreeText, margin, currentY);
    currentY += 8;
    
    // Add education details
    doc.setFont("helvetica", "normal");
    doc.text("Distinguished member of university's Accounting Society", margin, currentY);
    currentY += 6;
    
    doc.text("Relevant coursework: Advanced Financial Accounting and Reporting", margin, currentY);
    currentY += 6;
    
    doc.text("GPA: 3.8", margin, currentY);
    currentY += 15;
    
    // ===== SKILLS SECTION =====
    // Check if we need a new page
    if (currentY > pageHeight - 100) {
        doc.addPage();
        currentY = margin + 20;
    }
    
    // Skills header table
    doc.setDrawColor(0);
    doc.rect(margin, currentY, tableWidth, 20);
    doc.line(margin + leftColWidth, currentY, margin + leftColWidth, currentY + 20);
    
    // Add skills heading
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text("Skills", margin + 5, currentY + 13);
    
    currentY += 20; // Move to skills grid
    
    // Skills grid - create a 2x3 table
    const rowHeight = 20;
    const colWidth = tableWidth / 2;
    
    // Define skills (use provided or sample skills)
    const skillsList = userData.skills && userData.skills.length >= 6 ? 
        userData.skills.slice(0, 6) : 
        ["Microsoft NAV Dynamics", "Bookkeeping", "Cashflow planning & management", 
         "Exceptional communication", "State & federal tax codes", "Fluent in German"];
    
    // Create skills grid
    for (let row = 0; row < 3; row++) {
        // Draw row borders
        doc.rect(margin, currentY, colWidth, rowHeight);
        doc.rect(margin + colWidth, currentY, colWidth, rowHeight);
        
        // Add skills text for this row
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.text(skillsList[row*2], margin + 5, currentY + 13);
        doc.text(skillsList[row*2 + 1], margin + colWidth + 5, currentY + 13);
        
        // Move to next row
        currentY += rowHeight;
    }
    
    // Footer with page numbers
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFont("helvetica", "italic");
        doc.setFontSize(8);
        doc.setTextColor(100, 100, 100);
        doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
    }
    
    // Helper function for date formatting
    function formatDate(dateString) {
        if (!dateString) return '20XX';
        
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString || '20XX';
            
            // Format to match sample with 20XX pattern
            return '20XX';
        } catch (e) {
            return '20XX';
        }
    }
}
// Template 2 - Minimal Modern ATS-Friendly Resume
function generateTemplate2(doc, userData) {
    // Document setup - A4 size
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 20;
    const contentWidth = pageWidth - (margin * 2);
    
    // Set document properties with keywords for ATS
    doc.setProperties({
        title: `${userData.user_name} - ${userData.experiences?.[0]?.job_title || 'Professional'} Resume`,
        subject: `Resume - ${userData.skills.slice(0, 5).join(', ')}`,
        author: userData.user_name,
        keywords: userData.skills.join(', ') // Keywords help with ATS scanning
    });

    // Color theme
    const primaryColor = [42, 87, 141]; // Deep blue
    const secondaryColor = [90, 140, 190]; // Medium blue
    const accentColor = [230, 235, 240]; // Very light blue
    
    // Helper function for page overflow checking
    function checkPageOverflow(currentY, requiredSpace = 20) {
        if (currentY > pageHeight - requiredSpace) {
            doc.addPage();
            // Add header bar to new page
            doc.setFillColor(...primaryColor);
            doc.rect(0, 0, pageWidth, 12, 'F');
            return margin + 15;
        }
        return currentY;
    }
    
    // Helper function for date formatting
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString; // Return original if invalid
            
            const month = date.toLocaleString('default', { month: 'short' });
            const year = date.getFullYear();
            return `${month} ${year}`;
        } catch (e) {
            return dateString; // Fallback to original string
        }
    }
    
    // Header bar
    doc.setFillColor(...primaryColor);
    doc.rect(0, 0, pageWidth, 12, 'F');
    
    // Name and Contact Header Section
    let currentY = margin;
    
    // Name with distinctive styling
    doc.setFont("helvetica", "bold");
    doc.setFontSize(22);
    doc.setTextColor(...primaryColor);
    doc.text(userData.user_name.toUpperCase(), margin, currentY);
    
    // Get width of name for positioning
    const nameWidth = doc.getTextWidth(userData.user_name.toUpperCase());
    
    // Professional title (if available)
    if (userData.experiences && userData.experiences.length > 0) {
        doc.setFont("helvetica", "italic");
        doc.setFontSize(12);
        doc.setTextColor(80, 80, 80);
        doc.text(userData.experiences[0].job_title, margin, currentY + 8);
    }
    
    // Contact information - aligned right
    doc.setFont("helvetica", "normal");
    doc.setFontSize(9);
    doc.setTextColor(60, 60, 60);
    
    let contactY = currentY - 5;
    const contactX = pageWidth - margin;
    
    if (userData.email) {
        doc.text(userData.email, contactX, contactY, { align: 'right' });
        contactY += 5;
    }
    
    if (userData.mobile) {
        doc.text(userData.mobile, contactX, contactY, { align: 'right' });
        contactY += 5;
    }
    
    if (userData.location) {
        doc.text(userData.location, contactX, contactY, { align: 'right' });
        contactY += 5;
    }
    
    if (userData.linkedin) {
        doc.text(userData.linkedin, contactX, contactY, { align: 'right' });
        contactY += 5;
    }
    
    if (userData.github) {
        doc.text(userData.github, contactX, contactY, { align: 'right' });
    }
    
    currentY += 15;
    
    // Professional Summary Section
    if (userData.summary) {
        currentY += 8;
        
        // Section header with accent bar
        doc.setFillColor(...secondaryColor);
        doc.rect(margin, currentY, 5, 5, 'F');
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.setTextColor(...primaryColor);
        doc.text("PROFESSIONAL SUMMARY", margin + 12, currentY + 4);
        
        // Horizontal line
        doc.setDrawColor(...secondaryColor);
        doc.setLineWidth(0.5);
        doc.line(margin + 12 + doc.getTextWidth("PROFESSIONAL SUMMARY") + 5, currentY + 2, pageWidth - margin, currentY + 2);
        
        currentY += 10;
        
        // Summary content
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.setTextColor(50, 50, 50);
        const summaryLines = doc.splitTextToSize(userData.summary, contentWidth);
        doc.text(summaryLines, margin, currentY);
        currentY += summaryLines.length * 4.5 + 5;
    }
    
    // Skills Section
    currentY = checkPageOverflow(currentY, 50);
    currentY += 5;
    
    // Section header with accent bar
    doc.setFillColor(...secondaryColor);
    doc.rect(margin, currentY, 5, 5, 'F');
    
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.setTextColor(...primaryColor);
    doc.text("TECHNICAL SKILLS", margin + 12, currentY + 4);
    
    // Horizontal line
    doc.setDrawColor(...secondaryColor);
    doc.setLineWidth(0.5);
    doc.line(margin + 12 + doc.getTextWidth("TECHNICAL SKILLS") + 5, currentY + 2, pageWidth - margin, currentY + 2);
    
    currentY += 10;
    
    // Skills display with pill-style boxes
    if (userData.skills && userData.skills.length > 0) {
        doc.setFontSize(9);
        
        // Group skills in rows
        const skillsPerRow = 3;
        let rowX = margin;
        let pillHeight = 7;
        let pillMargin = 5;
        
        for (let i = 0; i < userData.skills.length; i++) {
            const skill = userData.skills[i];
            const skillWidth = doc.getTextWidth(skill) + 10; // Add padding
            
            // Check if we need to start a new row
            if (rowX + skillWidth > pageWidth - margin) {
                rowX = margin;
                currentY += pillHeight + pillMargin;
            }
            
            // Check for page overflow
            currentY = checkPageOverflow(currentY, pillHeight + 5);
            
            // Draw pill background
            doc.setFillColor(...accentColor);
            doc.roundedRect(rowX, currentY - 5, skillWidth, pillHeight, 2, 2, 'F');
            
            // Draw skill text
            doc.setFont("helvetica", "normal");
            doc.setTextColor(40, 40, 40);
            doc.text(skill, rowX + 5, currentY);
            
            // Move to next pill position
            rowX += skillWidth + pillMargin;
        }
        
        currentY += pillHeight + 8;
    } else {
        doc.setFont("helvetica", "italic");
        doc.setFontSize(10);
        doc.text("No skills provided", margin, currentY);
        currentY += 8;
    }
    
    // Experience Section
    currentY = checkPageOverflow(currentY, 60);
    currentY += 5;
    
    // Section header with accent bar
    doc.setFillColor(...secondaryColor);
    doc.rect(margin, currentY, 5, 5, 'F');
    
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.setTextColor(...primaryColor);
    doc.text("PROFESSIONAL EXPERIENCE", margin + 12, currentY + 4);
    
    // Horizontal line
    doc.setDrawColor(...secondaryColor);
    doc.setLineWidth(0.5);
    doc.line(margin + 12 + doc.getTextWidth("PROFESSIONAL EXPERIENCE") + 5, currentY + 2, pageWidth - margin, currentY + 2);
    
    currentY += 10;
    
    if (userData.experiences && userData.experiences.length > 0) {
        userData.experiences.forEach((exp, index) => {
            currentY = checkPageOverflow(currentY, 30);
            
            // Job title and company header
            doc.setFontSize(12);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(...primaryColor);
            doc.text(exp.job_title, margin, currentY);
            
            // Date range aligned right
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.setTextColor(80, 80, 80);
            const dateText = `${formatDate(exp.start_date)} - ${exp.currently_working ? 'Present' : formatDate(exp.end_date)}`;
            doc.text(dateText, pageWidth - margin, currentY, { align: 'right' });
            
            currentY += 5;
            
            // Company and location
            doc.setFont("helvetica", "normal");
            doc.setFontSize(11);
            doc.setTextColor(50, 50, 50);
            
            let companyText = exp.company_name;
            if (exp.location) {
                companyText += ` | ${exp.location}`;
            }
            
            doc.text(companyText, margin, currentY);
            currentY += 6;
            
            // Subtle separator
            doc.setDrawColor(200, 200, 200);
            doc.setLineWidth(0.2);
            doc.line(margin, currentY, pageWidth - margin, currentY);
            currentY += 5;
            
            // Description with enhanced bullet points
            if (exp.description) {
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(60, 60, 60);
                
                // Convert description to bullet points
                const bulletPoints = exp.description
                    .split('\n')
                    .filter(point => point.trim().length > 0);
                
                const formattedPoints = bulletPoints.length > 1 ? 
                    bulletPoints : 
                    exp.description.split('. ')
                        .filter(s => s.trim().length > 0)
                        .map(s => s.trim() + (s.endsWith('.') ? '' : '.'));
                
                formattedPoints.forEach(point => {
                    currentY = checkPageOverflow(currentY);
                    
                    // Modern arrow bullet
                    doc.setFont("zapfdingbats");
                    doc.text("", margin, currentY);
                    
                    // Bullet text
                    doc.setFont("helvetica", "normal");
                    const bulletText = doc.splitTextToSize(point.trim(), contentWidth - 10);
                    doc.text(bulletText, margin + 7, currentY);
                    currentY += bulletText.length * 4.5 + 2;
                });
            }
            
            currentY += 10; // Space between experiences
        });
    } else {
        doc.setFont("helvetica", "italic");
        doc.setFontSize(10);
        doc.text("No work experience provided", margin, currentY);
        currentY += 10;
    }
    
    // Education Section
    currentY = checkPageOverflow(currentY, 60);
    currentY += 5;
    
    // Section header with accent bar
    doc.setFillColor(...secondaryColor);
    doc.rect(margin, currentY, 5, 5, 'F');
    
    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.setTextColor(...primaryColor);
    doc.text("EDUCATION", margin + 12, currentY + 4);
    
    // Horizontal line
    doc.setDrawColor(...secondaryColor);
    doc.setLineWidth(0.5);
    doc.line(margin + 12 + doc.getTextWidth("EDUCATION") + 5, currentY + 2, pageWidth - margin, currentY + 2);
    
    currentY += 10;
    
    // Filter out education entries with empty institution names
    const validEducationEntries = [
        { type: "Graduation", school: userData.ug_college, year: userData.Passout_Year, score: userData.Graduation_Percentage },
        { type: "12th", school: userData.twelfth_school, year: userData.twelfth_year, score: userData.twelfth_percentage },
        { type: "10th", school: userData.tenth_school, year: userData.tenth_year, score: userData.Percentage_10 }
    ].filter(edu => edu.school && edu.school.trim() !== "");
    
    if (validEducationEntries.length > 0) {
        validEducationEntries.forEach((edu, index) => {
            currentY = checkPageOverflow(currentY, 25);
            
            // Modern card-like design for each education entry
            doc.setFillColor(...accentColor);
            doc.roundedRect(margin, currentY - 5, contentWidth, 30, 2, 2, 'F');
            
            // Degree/type
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.setTextColor(...primaryColor);
            doc.text(edu.type, margin + 8, currentY + 5);
            
            // Year aligned right
            if (edu.year) {
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(edu.year.toString(), pageWidth - margin - 8, currentY + 5, { align: 'right' });
            }
            
            // Institution
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.setTextColor(50, 50, 50);
            doc.text(edu.school, margin + 8, currentY + 15);
            
            // Score
            if (edu.score) {
                doc.setFont("helvetica", "italic");
                doc.setTextColor(80, 80, 80);
                doc.text(`Score: ${edu.score}`, pageWidth - margin - 8, currentY + 15, { align: 'right' });
            }
            
            currentY += 35; // Move to next education entry
        });
    } else {
        doc.setFont("helvetica", "italic");
        doc.setFontSize(10);
        doc.text("No education details provided", margin, currentY);
        currentY += 10;
    }
    
    // Projects Section
    if (userData.projects && userData.projects.length > 0) {
        currentY = checkPageOverflow(currentY, 60);
        currentY += 5;
        
        // Section header with accent bar
        doc.setFillColor(...secondaryColor);
        doc.rect(margin, currentY, 5, 5, 'F');
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(14);
        doc.setTextColor(...primaryColor);
        doc.text("PROJECTS", margin + 12, currentY + 4);
        
        // Horizontal line
        doc.setDrawColor(...secondaryColor);
        doc.setLineWidth(0.5);
        doc.line(margin + 12 + doc.getTextWidth("PROJECTS") + 5, currentY + 2, pageWidth - margin, currentY + 2);
        
        currentY += 10;
        
        userData.projects.forEach((project, index) => {
            currentY = checkPageOverflow(currentY, 30);
            
            // Project title with background highlight
            doc.setFillColor(...accentColor);
            doc.rect(margin, currentY - 2, contentWidth, 1, 'F');
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.setTextColor(...primaryColor);
            doc.text(project.title, margin, currentY + 6);
            
            // Date range aligned right
            doc.setFont("helvetica", "italic");
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            const projDateText = `${formatDate(project.start_date)} - ${project.currently_ongoing ? 'Present' : formatDate(project.end_date)}`;
            doc.text(projDateText, pageWidth - margin, currentY + 6, { align: 'right' });
            
            currentY += 12;
            
            // Project description
            if (project.description) {
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                doc.setTextColor(60, 60, 60);
                
                // Format description as bullet points
                const projectPoints = project.description
                    .split('\n')
                    .filter(point => point.trim().length > 0);
                
                const formattedProjectPoints = projectPoints.length > 1 ? 
                    projectPoints : 
                    project.description.split('. ')
                        .filter(s => s.trim().length > 0)
                        .map(s => s.trim() + (s.endsWith('.') ? '' : '.'));
                
                formattedProjectPoints.forEach(point => {
                    currentY = checkPageOverflow(currentY);
                    
                    // Diamond bullet
                    doc.setFont("zapfdingbats");
                    doc.text("", margin, currentY);
                    
                    // Bullet text
                    doc.setFont("helvetica", "normal");
                    const bulletText = doc.splitTextToSize(point.trim(), contentWidth - 10);
                    doc.text(bulletText, margin + 7, currentY);
                    currentY += bulletText.length * 4.5 + 2;
                });
            }
            
            // Technologies used
            if (project.technologies) {
                currentY = checkPageOverflow(currentY);
                
                doc.setFont("helvetica", "bold");
                doc.setFontSize(9);
                doc.setTextColor(80, 80, 80);
                doc.text("Technologies:", margin, currentY);
                
                doc.setFont("helvetica", "normal");
                const techText = Array.isArray(project.technologies) ? 
                    project.technologies.join(", ") : project.technologies;
                
                const techLines = doc.splitTextToSize(techText, contentWidth - 40);
                doc.text(techLines, margin + 35, currentY);
                currentY += techLines.length * 4 + 2;
            }
            
            // Project link
            if (project.link) {
                currentY = checkPageOverflow(currentY);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0, 102, 204); // Link color
                doc.text(`Link: ${project.link}`, margin, currentY);
                currentY += 5;
            }
            
            currentY += 8; // Space between projects
        });
    }
    
    // Footer with page numbers
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFillColor(...primaryColor);
        doc.rect(0, pageHeight - 12, pageWidth, 12, 'F');
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(8);
        doc.setTextColor(255, 255, 255);
        doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, pageHeight - 4, { align: 'right' });
    }
}
// Template 3 - Executive Minimalist Resume with Horizontal Sections
function generateTemplate3(doc, userData) {
    // Document setup - A4 size
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 20;
    const contentWidth = pageWidth - (margin * 2);
    
    // Set document properties with keywords for ATS
    doc.setProperties({
        title: `${userData.user_name} - ${userData.experiences?.[0]?.job_title || 'Professional'} Resume`,
        subject: `Resume - ${userData.skills.slice(0, 5).join(', ')}`,
        author: userData.user_name,
        keywords: userData.skills.join(', ') // Keywords help with ATS scanning
    });

    // Color scheme - Executive burgundy and charcoal
    const primaryColor = [128, 0, 32]; // Burgundy/wine red
    const secondaryColor = [50, 50, 50]; // Charcoal
    const accentColor = [180, 180, 180]; // Light gray
    const highlightColor = [200, 160, 165]; // Light burgundy for highlights
    
    let currentY = 20;
    
    // Header with minimalist top border
    doc.setDrawColor(...primaryColor);
    doc.setLineWidth(2);
    doc.line(margin, currentY - 10, pageWidth - margin, currentY - 10);
    
    // Name and title in large, elegant typography
    doc.setFont("helvetica", "bold");
    doc.setFontSize(28);
    doc.setTextColor(...primaryColor);
    doc.text(userData.user_name.toUpperCase(), margin, currentY);
    
    // Professional title and contact info in horizontal layout
    if (userData.experiences && userData.experiences.length > 0) {
        doc.setFont("helvetica", "normal");
        doc.setFontSize(12);
        doc.setTextColor(...secondaryColor);
        doc.text(userData.experiences[0].job_title, pageWidth - margin, currentY, { align: 'right' });
    }
    
    currentY += 15;
    
    // Contact information in elegant horizontal bar
    doc.setFillColor(...highlightColor);
    doc.rect(0, currentY - 5, pageWidth, 24, 'F');
    
    // Contact details in centered, spaced format
    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    doc.setTextColor(...secondaryColor);
    
    // Gather contact elements
    const contactElements = [];
    if (userData.email) contactElements.push(`Email: ${userData.email}`);
    if (userData.mobile) contactElements.push(`Phone: ${userData.mobile}`);
    if (userData.location) contactElements.push(`Location: ${userData.location}`);
    if (userData.linkedin) contactElements.push(`LinkedIn: ${userData.linkedin}`);
    if (userData.github) contactElements.push(`GitHub: ${userData.github}`);
    
    // Calculate spacing for horizontal arrangement
    const elementWidth = contactElements.length > 0 ? contentWidth / contactElements.length : 0;
    
    // Place contact elements horizontally
    contactElements.forEach((element, index) => {
        const xPosition = margin + (elementWidth * index) + (elementWidth / 2);
        doc.text(element, xPosition, currentY + 8, { align: 'center' });
    });
    
    currentY += 24;
    
    // Professional Summary in clean box if available
    if (userData.summary) {
        currentY += 10;
        doc.setDrawColor(...accentColor);
        doc.setLineWidth(0.5);
        doc.roundedRect(margin, currentY, contentWidth, 40, 2, 2, 'D');
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.setTextColor(...primaryColor);
        doc.text("PROFESSIONAL SUMMARY", margin + 5, currentY + 10);
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.setTextColor(...secondaryColor);
        const summaryLines = doc.splitTextToSize(userData.summary, contentWidth - 10);
        doc.text(summaryLines, margin + 5, currentY + 20);
        
        currentY += 50;
    }
    
    // MAIN CONTENT LAYOUT - Three column grid for Skills
    currentY += 5;
    
    // Section heading with burgundy underline
    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.setTextColor(...primaryColor);
    doc.text("PROFESSIONAL SKILLS", margin, currentY);
    
    doc.setDrawColor(...primaryColor);
    doc.setLineWidth(1);
    doc.line(margin, currentY + 4, margin + 70, currentY + 4);
    
    currentY += 15;
    
    // Skills in 3-column grid with elegant styling
    if (userData.skills && userData.skills.length > 0) {
        doc.setFont("helvetica", "normal");
        doc.setFontSize(10);
        doc.setTextColor(...secondaryColor);
        
        const columnWidth = contentWidth / 3;
        let skillsPerColumn = Math.ceil(userData.skills.length / 3);
        
        // Limit to reasonable number to prevent overflow
        const maxSkillsToShow = Math.min(userData.skills.length, 21);
        
        for (let i = 0; i < maxSkillsToShow; i++) {
            const columnIndex = Math.floor(i / skillsPerColumn);
            const rowIndex = i % skillsPerColumn;
            
            const xPos = margin + (columnIndex * columnWidth);
            const yPos = currentY + (rowIndex * 6);
            
            // Check if we need a new page
            if (yPos > pageHeight - 40) {
                doc.addPage();
                currentY = margin + 10;
                // Reset positioning for new page
                i = i - rowIndex;
                continue;
            }
            
            doc.setFillColor(...primaryColor);
            doc.circle(xPos + 2, yPos - 2, 1, 'F');
            doc.text(userData.skills[i], xPos + 6, yPos);
        }
        
        currentY += (skillsPerColumn * 6) + 10;
    } else {
        doc.setFont("helvetica", "italic");
        doc.setFontSize(10);
        doc.text("No skills provided", margin, currentY);
        currentY += 15;
    }
    
    // Work Experience Section with elegant timeline-style layout
    // Check if we need a new page
    if (currentY > pageHeight - 60) {
        doc.addPage();
        currentY = margin + 10;
    }
    
    // Section heading with burgundy underline
    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.setTextColor(...primaryColor);
    doc.text("PROFESSIONAL EXPERIENCE", margin, currentY);
    
    doc.setDrawColor(...primaryColor);
    doc.setLineWidth(1);
    doc.line(margin, currentY + 4, margin + 100, currentY + 4);
    
    currentY += 15;
    
    // Timeline-style vertical line
    const timelineX = margin + 8;
    let timelineStartY = currentY;
    
    if (userData.experiences && userData.experiences.length > 0) {
        userData.experiences.forEach((exp, index) => {
            // Check if we need a new page
            if (currentY > pageHeight - 50) {
                // Draw timeline on current page
                doc.setDrawColor(...accentColor);
                doc.setLineWidth(1);
                doc.line(timelineX, timelineStartY, timelineX, pageHeight - margin);
                
                // Add new page
                doc.addPage();
                currentY = margin + 20;
                timelineStartY = currentY;
                
                // Restart timeline heading on new page if needed
                if (index > 0) {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(16);
                    doc.setTextColor(...primaryColor);
                    doc.text("PROFESSIONAL EXPERIENCE (cont.)", margin, currentY - 10);
                    
                    doc.setDrawColor(...primaryColor);
                    doc.setLineWidth(1);
                    doc.line(margin, currentY - 6, margin + 130, currentY - 6);
                }
            }
            
            // Timeline dot
            doc.setFillColor(...primaryColor);
            doc.circle(timelineX, currentY, 3, 'F');
            
            // Job info with elegant spacing
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.setTextColor(...secondaryColor);
            doc.text(exp.job_title.toUpperCase(), timelineX + 15, currentY);
            
            // Dates aligned right with elegant typography
            const dateText = `${formatDate(exp.start_date)} - ${exp.currently_working ? 'Present' : formatDate(exp.end_date)}`;
            doc.setFont("helvetica", "italic");
            doc.setFontSize(10);
            doc.text(dateText, pageWidth - margin, currentY, { align: 'right' });
            
            currentY += 7;
            
            // Company with location
            doc.setFont("helvetica", "normal");
            doc.setFontSize(11);
            let companyText = exp.company_name;
            if (exp.location) {
                companyText += ` | ${exp.location}`;
            }
            doc.text(companyText, timelineX + 15, currentY);
            
            currentY += 10;
            
            // Description with enhanced formatting
            if (exp.description) {
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                
                const bulletPoints = exp.description
                    .split('\n')
                    .filter(point => point.trim().length > 0);
                
                // If no explicit bullet points, create from paragraph
                const formattedPoints = bulletPoints.length > 1 ? 
                    bulletPoints : 
                    exp.description.split('. ')
                        .filter(s => s.trim().length > 0)
                        .map(s => s.trim() + (s.endsWith('.') ? '' : '.'));
                
                formattedPoints.forEach(point => {
                    // Check for page overflow
                    if (currentY > pageHeight - 30) {
                        // Complete timeline on current page
                        doc.setDrawColor(...accentColor);
                        doc.setLineWidth(1);
                        doc.line(timelineX, timelineStartY, timelineX, pageHeight - margin);
                        
                        // Add new page
                        doc.addPage();
                        currentY = margin + 20;
                        timelineStartY = currentY;
                    }
                    
                    // Add diamond bullet point
                    doc.setFillColor(...highlightColor);
                    doc.rect(timelineX + 15, currentY - 3, 3, 3, 'F');
                    
                    // Text with hanging indent
                    const bulletWidth = pageWidth - timelineX - margin - 25;
                    const bulletText = doc.splitTextToSize(point.trim(), bulletWidth);
                    doc.text(bulletText, timelineX + 22, currentY);
                    currentY += bulletText.length * 5;
                });
                
                currentY += 5;
            }
        });
        
        // Complete the timeline
        doc.setDrawColor(...accentColor);
        doc.setLineWidth(1);
        doc.line(timelineX, timelineStartY, timelineX, currentY - 5);
    } else {
        doc.setFont("helvetica", "italic");
        doc.setFontSize(10);
        doc.text("No work experience provided", margin, currentY);
        currentY += 15;
    }
    
    // Education in elegant table format
    // Check if we need a new page
    if (currentY > pageHeight - 80) {
        doc.addPage();
        currentY = margin + 10;
    } else {
        currentY += 15;
    }
    
    // Section heading with burgundy underline
    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.setTextColor(...primaryColor);
    doc.text("EDUCATION", margin, currentY);
    
    doc.setDrawColor(...primaryColor);
    doc.setLineWidth(1);
    doc.line(margin, currentY + 4, margin + 40, currentY + 4);
    
    currentY += 15;
    
    // Filter out education entries with empty institution names
    const validEducationEntries = [
        ["Graduation", userData.ug_college, userData.Passout_Year, userData.Graduation_Percentage],
        ["12th", userData.twelfth_school, userData.twelfth_year, userData.twelfth_percentage],
        ["10th", userData.tenth_school, userData.tenth_year, userData.Percentage_10]
    ].filter(row => row[1] && row[1].trim() !== "");
    
    if (validEducationEntries.length > 0) {
        // Create elegant education table
        doc.autoTable({
            startY: currentY,
            head: [["Degree", "Institution", "Year", "Score"]],
            body: validEducationEntries,
            margin: { left: margin, right: margin },
            styles: { 
                fontSize: 10, 
                cellPadding: 6,
                overflow: 'linebreak',
                lineColor: [200, 200, 200]
            },
            headStyles: { 
                fillColor: [...primaryColor],
                textColor: [255, 255, 255],
                fontStyle: 'bold'
            },
            alternateRowStyles: { 
                fillColor: [245, 235, 235] // Very light burgundy
            },
            columnStyles: {
                0: { cellWidth: 50 },
                1: { cellWidth: 'auto' },
                2: { cellWidth: 30 },
                3: { cellWidth: 30 }
            }
        });
        currentY = doc.lastAutoTable.finalY + 15;
    } else {
        doc.setFont("helvetica", "italic");
        doc.setFontSize(10);
        doc.text("No education details provided", margin, currentY);
        currentY += 15;
    }
    
    // Projects Section with card-like layout
    if (userData.projects && userData.projects.length > 0) {
        // Check if we need a new page
        if (currentY > pageHeight - 60) {
            doc.addPage();
            currentY = margin + 10;
        }
        
        // Section heading with burgundy underline
        doc.setFont("helvetica", "bold");
        doc.setFontSize(16);
        doc.setTextColor(...primaryColor);
        doc.text("KEY PROJECTS", margin, currentY);
        
        doc.setDrawColor(...primaryColor);
        doc.setLineWidth(1);
        doc.line(margin, currentY + 4, margin + 50, currentY + 4);
        
        currentY += 15;
        
        userData.projects.forEach((project, i) => {
            // Check for page overflow
            if (currentY > pageHeight - 50) {
                doc.addPage();
                currentY = margin + 10;
                
                if (i > 0) {
                    doc.setFont("helvetica", "bold");
                    doc.setFontSize(16);
                    doc.setTextColor(...primaryColor);
                    doc.text("KEY PROJECTS (cont.)", margin, currentY);
                    
                    doc.setDrawColor(...primaryColor);
                    doc.setLineWidth(1);
                    doc.line(margin, currentY + 4, margin + 80, currentY + 4);
                    
                    currentY += 15;
                }
            }
            
            // Card-like border for each project
            doc.setDrawColor(...accentColor);
            doc.roundedRect(margin, currentY, contentWidth, 5, 0, 0, 'F'); // Top bar
            
            currentY += 8;
            
            // Project title with elegant typography
            doc.setFont("helvetica", "bold");
            doc.setFontSize(12);
            doc.setTextColor(...primaryColor);
            doc.text(project.title, margin + 5, currentY);
            
            // Project duration with elegant formatting
            doc.setFont("helvetica", "italic");
            doc.setFontSize(10);
            doc.setTextColor(...secondaryColor);
            const projDateText = `${formatDate(project.start_date)} - ${project.currently_ongoing ? 'Present' : formatDate(project.end_date)}`;
            doc.text(projDateText, pageWidth - margin, currentY, { align: 'right' });
            
            currentY += 8;
            
            // Project description with refined styling
            if (project.description) {
                doc.setFont("helvetica", "normal");
                doc.setFontSize(10);
                
                // Convert description to bullet points
                const projectPoints = project.description
                    .split('\n')
                    .filter(point => point.trim().length > 0);
                
                const formattedProjectPoints = projectPoints.length > 1 ? 
                    projectPoints : 
                    project.description.split('. ')
                        .filter(s => s.trim().length > 0)
                        .map(s => s.trim() + (s.endsWith('.') ? '' : '.'));
                
                formattedProjectPoints.forEach(point => {
                    // Check for page overflow
                    if (currentY > pageHeight - 30) {
                        doc.addPage();
                        currentY = margin + 10;
                    }
                    
                    // Add elegant diamond bullet
                    doc.setFillColor(...highlightColor);
                    doc.rect(margin + 5, currentY - 3, 3, 3, 'F');
                    
                    const bulletWidth = contentWidth - 15;
                    const bulletText = doc.splitTextToSize(point.trim(), bulletWidth);
                    doc.text(bulletText, margin + 12, currentY);
                    currentY += bulletText.length * 5;
                });
            }

            // Project link if available
            if (project.link) {
                doc.setFont("helvetica", "normal");
                doc.setTextColor(...primaryColor);
                doc.text(`Visit: ${project.link}`, margin + 5, currentY);
                currentY += 8;
            }
            
            // Add technologies with elegant tag-like appearance
            if (project.technologies) {
                // Check for page overflow
                if (currentY > pageHeight - 20) {
                    doc.addPage();
                    currentY = margin + 10;
                }
                
                doc.setFont("helvetica", "bold");
                doc.setFontSize(10);
                doc.setTextColor(...secondaryColor);
                doc.text("Technologies:", margin + 5, currentY);
                
                doc.setFont("helvetica", "normal");
                currentY += 5;
                
                // Create visual tag-like elements for technologies
                let techList = Array.isArray(project.technologies) ? 
                    project.technologies : project.technologies.split(',').map(t => t.trim());
                
                const tagWidth = (contentWidth - 10) / 3;
                let tagX = margin + 5;
                let tagY = currentY;
                
                techList.forEach((tech, idx) => {
                    // Check if we need to start a new row
                    if (idx > 0 && idx % 3 === 0) {
                        tagX = margin + 5;
                        tagY += 8;
                    }
                    
                    // Check for page overflow
                    if (tagY > pageHeight - 20) {
                        doc.addPage();
                        tagY = margin + 10;
                        tagX = margin + 5;
                    }
                    
                    // Draw tag background
                    doc.setFillColor(...highlightColor);
                    doc.roundedRect(tagX, tagY - 4, Math.min(tech.length * 4 + 6, tagWidth - 5), 6, 2, 2, 'F');
                    
                    // Add tech name
                    doc.setTextColor(...secondaryColor);
                    doc.text(tech, tagX + 3, tagY);
                    
                    // Move to next tag position
                    tagX += Math.min(tech.length * 4 + 10, tagWidth);
                });
                
                currentY = tagY + 12;
            } else {
                currentY += 5;
            }
            
            // Bottom border
            doc.setDrawColor(...accentColor);
            doc.setLineWidth(0.5);
            doc.line(margin, currentY, margin + contentWidth, currentY);
            
            currentY += 10;
        });
    }
    
    // Footer with elegant page numbers and subtle branding
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        
        // Bottom page border
        doc.setFillColor(...primaryColor);
        doc.rect(0, pageHeight - 12, pageWidth, 12, 'F');
        
        // Page numbers
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.setTextColor(255, 255, 255);
        doc.text(`${userData.user_name}  Page ${i} of ${totalPages}`, pageWidth / 2, pageHeight - 4, { align: 'center' });
    }
    
    // Helper function for date formatting
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString; // Return original if invalid
            
            const month = date.toLocaleString('default', { month: 'short' });
            const year = date.getFullYear();
            return `${month} ${year}`;
        } catch (e) {
            return dateString; // Fallback to original string
        }
    }
}

// Template 4 - Modern Two-Column ATS-Friendly Resume
function generateTemplate4(doc, userData) {
    // Document setup - A4 size
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 15;
    
    // Define column widths
    const leftColWidth = 55; // Sidebar width
    const rightColWidth = pageWidth - leftColWidth - (margin * 2);
    const rightColStart = leftColWidth + margin;
    
    // Set document properties with keywords for ATS
    doc.setProperties({
        title: `${userData.user_name} - ${userData.experiences?.[0]?.job_title || 'Professional'} Resume`,
        subject: `Resume - ${userData.skills.slice(0, 5).join(', ')}`,
        author: userData.user_name,
        keywords: userData.skills.join(', ') // Keywords help with ATS scanning
    });

    // Helper function for page overflow checking
    function checkPageOverflow(currentY, requiredSpace = 20) {
        if (currentY > pageHeight - requiredSpace) {
            doc.addPage();
            
            // Draw sidebar background on new page
            doc.setFillColor(240, 240, 245);
            doc.rect(margin, margin, leftColWidth, pageHeight - (margin * 2), 'F');
            
            return margin + 15;
        }
        return currentY;
    }
    
    // Helper function for date formatting
    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString; // Return original if invalid
            
            const month = date.toLocaleString('default', { month: 'short' });
            const year = date.getFullYear();
            return `${month} ${year}`;
        } catch (e) {
            return dateString; // Fallback to original string
        }
    }

    // Draw sidebar background
    doc.setFillColor(240, 240, 245); // Light blue-grey
    doc.rect(margin, margin, leftColWidth, pageHeight - (margin * 2), 'F');
    
    // ===== LEFT COLUMN (SIDEBAR) =====
    let leftY = margin + 15;
    
    // Name header in sidebar
    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.setTextColor(50, 50, 80); // Dark blue-grey
    
    // Split name into first and last for visual interest
    const nameParts = userData.user_name.split(' ');
    if (nameParts.length > 1) {
        const firstName = nameParts[0];
        const lastName = nameParts.slice(1).join(' ');
        
        doc.text(firstName, margin + 5, leftY);
        leftY += 8;
        doc.setFontSize(18);
        doc.setTextColor(30, 30, 70); // Slightly darker
        doc.text(lastName.toUpperCase(), margin + 5, leftY);
    } else {
        // If can't split name, just show full name
        doc.setFontSize(18);
        doc.text(userData.user_name.toUpperCase(), margin + 5, leftY);
    }
    leftY += 12;
    
    // Profile photo placeholder with circular mask (optional)
    /*
    doc.setDrawColor(255, 255, 255);
    doc.setLineWidth(1);
    doc.circle(margin + leftColWidth/2, leftY + 20, 20, 'S');
    leftY += 50;
    */
    
    // Contact section
    doc.setFillColor(60, 60, 100);
    doc.rect(margin + 5, leftY, leftColWidth - 10, 1, 'F');
    leftY += 6;
    
    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);
    doc.setTextColor(60, 60, 100);
    doc.text("CONTACT", margin + 5, leftY);
    leftY += 7;
    
    // Contact details
    doc.setFont("helvetica", "normal");
    doc.setFontSize(8);
    doc.setTextColor(40, 40, 40);
    
    if (userData.email) {
        doc.text("Email:", margin + 5, leftY);
        leftY += 4;
        doc.setFont("helvetica", "normal");
        const emailLines = doc.splitTextToSize(userData.email, leftColWidth - 10);
        doc.text(emailLines, margin + 5, leftY);
        leftY += emailLines.length * 4 + 2;
    }
    
    if (userData.mobile) {
        doc.setFont("helvetica", "bold");
        doc.text("Phone:", margin + 5, leftY);
        leftY += 4;
        doc.setFont("helvetica", "normal");
        doc.text(userData.mobile, margin + 5, leftY);
        leftY += 6;
    }
    
    if (userData.location) {
        doc.setFont("helvetica", "bold");
        doc.text("Location:", margin + 5, leftY);
        leftY += 4;
        doc.setFont("helvetica", "normal");
        const locationLines = doc.splitTextToSize(userData.location, leftColWidth - 10);
        doc.text(locationLines, margin + 5, leftY);
        leftY += locationLines.length * 4 + 2;
    }
    
    // LinkedIn
    if (userData.linkedin) {
        doc.setFont("helvetica", "bold");
        doc.text("LinkedIn:", margin + 5, leftY);
        leftY += 4;
        doc.setFont("helvetica", "normal");
        const linkedinLines = doc.splitTextToSize(userData.linkedin, leftColWidth - 10);
        doc.text(linkedinLines, margin + 5, leftY);
        leftY += linkedinLines.length * 4 + 2;
    }
    
    // GitHub
    if (userData.github) {
        doc.setFont("helvetica", "bold");
        doc.text("GitHub:", margin + 5, leftY);
        leftY += 4;
        doc.setFont("helvetica", "normal");
        const githubLines = doc.splitTextToSize(userData.github, leftColWidth - 10);
        doc.text(githubLines, margin + 5, leftY);
        leftY += githubLines.length * 4 + 2;
    }
    
    leftY += 8;
    
    // Skills Section in sidebar
    leftY = checkPageOverflow(leftY, 30);
    doc.setFillColor(60, 60, 100);
    doc.rect(margin + 5, leftY, leftColWidth - 10, 1, 'F');
    leftY += 6;
    
    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);
    doc.setTextColor(60, 60, 100);
    doc.text("SKILLS", margin + 5, leftY);
    leftY += 7;
    
    doc.setFont("helvetica", "normal");
    doc.setFontSize(8);
    doc.setTextColor(40, 40, 40);
    
    if (userData.skills && userData.skills.length > 0) {
        userData.skills.forEach((skill) => {
            leftY = checkPageOverflow(leftY);
            
            // Small decorative bullet
            doc.setDrawColor(80, 80, 120); 
            doc.circle(margin + 7, leftY - 1.5, 1, 'FD');
            
            // Skill text
            const skillText = doc.splitTextToSize(skill, leftColWidth - 15);
            doc.text(skillText, margin + 10, leftY);
            leftY += skillText.length * 4 + 3;
        });
    } else {
        doc.setFont("helvetica", "italic");
        doc.text("No skills listed", margin + 5, leftY);
        leftY += 5;
    }
    
    leftY += 8;
    
    // Education section in sidebar
    leftY = checkPageOverflow(leftY, 40);
    doc.setFillColor(60, 60, 100);
    doc.rect(margin + 5, leftY, leftColWidth - 10, 1, 'F');
    leftY += 6;
    
    doc.setFont("helvetica", "bold");
    doc.setFontSize(10);
    doc.setTextColor(60, 60, 100);
    doc.text("EDUCATION", margin + 5, leftY);
    leftY += 10;
    
    // Filter out education entries with empty institution names
    const validEducationEntries = [
        { type: "Graduation", school: userData.ug_college, year: userData.Passout_Year, score: userData.Graduation_Percentage },
        { type: "12th", school: userData.twelfth_school, year: userData.twelfth_year, score: userData.twelfth_percentage },
        { type: "10th", school: userData.tenth_school, year: userData.tenth_year, score: userData.Percentage_10 }
    ].filter(edu => edu.school && edu.school.trim() !== "");
    
    if (validEducationEntries.length > 0) {
        validEducationEntries.forEach((edu) => {
            leftY = checkPageOverflow(leftY, 25);
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(9);
            doc.setTextColor(40, 40, 70);
            doc.text(edu.type, margin + 5, leftY);
            leftY += 4;
            
            doc.setFont("helvetica", "normal");
            doc.setFontSize(8);
            doc.setTextColor(40, 40, 40);
            
            // Institution name
            const schoolLines = doc.splitTextToSize(edu.school, leftColWidth - 10);
            doc.text(schoolLines, margin + 5, leftY);
            leftY += schoolLines.length * 4;
            
            // Year and score
            doc.setFont("helvetica", "italic");
            if (edu.year) {
                doc.text(`Year: ${edu.year}`, margin + 5, leftY);
                leftY += 4;
            }
            
            if (edu.score) {
                doc.text(`Score: ${edu.score}`, margin + 5, leftY);
                leftY += 4;
            }
            
            leftY += 6;
        });
    } else {
        doc.setFont("helvetica", "italic");
        doc.setFontSize(8);
        doc.text("No education details provided", margin + 5, leftY);
        leftY += 6;
    }
    
    // ===== RIGHT COLUMN (MAIN CONTENT) =====
    let rightY = margin + 15;
    
    // Professional headline/title
    if (userData.experiences && userData.experiences.length > 0) {
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.setTextColor(60, 60, 100);
        doc.text(userData.experiences[0].job_title.toUpperCase(), rightColStart, rightY);
        rightY += 8;
    }
    
    // Professional Summary
    if (userData.summary) {
        doc.setFillColor(60, 60, 100);
        doc.rect(rightColStart, rightY, rightColWidth, 1, 'F');
        rightY += 6;
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.setTextColor(60, 60, 100);
        doc.text("PROFESSIONAL SUMMARY", rightColStart, rightY);
        rightY += 6;
        
        doc.setFont("helvetica", "normal");
        doc.setFontSize(9);
        doc.setTextColor(40, 40, 40);
        const summaryLines = doc.splitTextToSize(userData.summary, rightColWidth);
        doc.text(summaryLines, rightColStart, rightY);
        rightY += summaryLines.length * 4 + 10;
    }
    
    // Experience Section
    rightY = checkPageOverflow(rightY, 40);
    doc.setFillColor(60, 60, 100);
    doc.rect(rightColStart, rightY, rightColWidth, 1, 'F');
    rightY += 6;
    
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.setTextColor(60, 60, 100);
    doc.text("PROFESSIONAL EXPERIENCE", rightColStart, rightY);
    rightY += 10;
    
    if (userData.experiences && userData.experiences.length > 0) {
        userData.experiences.forEach((exp, index) => {
            rightY = checkPageOverflow(rightY, 30);
            
            // Stylized timeline dot and line
            if (index > 0) {
                doc.setDrawColor(200, 200, 210);
                doc.setLineWidth(0.5);
                doc.line(rightColStart + 3, rightY - 6, rightColStart + 3, rightY - 3);
            }
            
            doc.setFillColor(60, 60, 100);
            doc.circle(rightColStart + 3, rightY, 2, 'F');
            
            if (index < userData.experiences.length - 1) {
                doc.setDrawColor(200, 200, 210);
                doc.setLineWidth(0.5);
                // Calculate approximate height of this experience entry to position line
                const estimatedHeight = exp.description ? 
                    (exp.description.split('\n').length * 4) + 20 : 20;
                doc.line(rightColStart + 3, rightY + 3, rightColStart + 3, rightY + estimatedHeight);
            }
            
            // Job Title
            doc.setFont("helvetica", "bold");
            doc.setFontSize(11);
            doc.setTextColor(40, 40, 70);
            doc.text(exp.job_title, rightColStart + 8, rightY);
            
            // Date range aligned right
            doc.setFont("helvetica", "italic");
            doc.setFontSize(9);
            doc.setTextColor(100, 100, 100);
            const dateText = `${formatDate(exp.start_date)} - ${exp.currently_working ? 'Present' : formatDate(exp.end_date)}`;
            doc.text(dateText, rightColStart + rightColWidth, rightY, { align: 'right' });
            rightY += 5;
            
            // Company and location
            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.setTextColor(40, 40, 40);
            
            let companyLocationText = exp.company_name;
            if (exp.location) {
                companyLocationText += ` | ${exp.location}`;
            }
            
            doc.text(companyLocationText, rightColStart + 8, rightY);
            rightY += 6;
            
            // Description with bullet points
            if (exp.description) {
                doc.setFontSize(9);
                
                // Convert description to bullet points
                const bulletPoints = exp.description
                    .split('\n')
                    .filter(point => point.trim().length > 0);
                
                const formattedPoints = bulletPoints.length > 1 ? 
                    bulletPoints : 
                    exp.description.split('. ')
                        .filter(s => s.trim().length > 0)
                        .map(s => s.trim() + (s.endsWith('.') ? '' : '.'));
                
                formattedPoints.forEach(point => {
                    rightY = checkPageOverflow(rightY);
                    
                    // Small decorative bullet
                    doc.setFillColor(180, 180, 200);
                    doc.circle(rightColStart + 10, rightY - 1.5, 1, 'F');
                    
                    // Bullet text
                    const bulletText = doc.splitTextToSize(point.trim(), rightColWidth - 15);
                    doc.text(bulletText, rightColStart + 14, rightY);
                    rightY += bulletText.length * 4 + 2;
                });
            }
            
            rightY += 10; // Space between experiences
        });
    } else {
        doc.setFont("helvetica", "italic");
        doc.setFontSize(9);
        doc.text("No work experience provided", rightColStart, rightY);
        rightY += 10;
    }
    
    // Projects Section
    if (userData.projects && userData.projects.length > 0) {
        rightY = checkPageOverflow(rightY, 40);
        doc.setFillColor(60, 60, 100);
        doc.rect(rightColStart, rightY, rightColWidth, 1, 'F');
        rightY += 6;
        
        doc.setFont("helvetica", "bold");
        doc.setFontSize(12);
        doc.setTextColor(60, 60, 100);
        doc.text("PROJECTS", rightColStart, rightY);
        rightY += 10;
        
        userData.projects.forEach((project, index) => {
            rightY = checkPageOverflow(rightY, 30);
            
            // Project title with modern highlight
            doc.setFillColor(230, 230, 240);
            doc.roundedRect(rightColStart, rightY - 4, rightColWidth, 12, 1, 1, 'F');
            
            doc.setFont("helvetica", "bold");
            doc.setFontSize(10);
            doc.setTextColor(40, 40, 70);
            doc.text(project.title, rightColStart + 4, rightY + 2);
            
            // Project duration aligned right
            doc.setFont("helvetica", "italic");
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            const projDateText = `${formatDate(project.start_date)} - ${project.currently_ongoing ? 'Present' : formatDate(project.end_date)}`;
            doc.text(projDateText, rightColStart + rightColWidth - 4, rightY + 2, { align: 'right' });
            rightY += 12;
            
            // Project description
            if (project.description) {
                doc.setFont("helvetica", "normal");
                doc.setFontSize(9);
                doc.setTextColor(40, 40, 40);
                
                // Convert description to bullet points
                const projectPoints = project.description
                    .split('\n')
                    .filter(point => point.trim().length > 0);
                
                const formattedProjectPoints = projectPoints.length > 1 ? 
                    projectPoints : 
                    project.description.split('. ')
                        .filter(s => s.trim().length > 0)
                        .map(s => s.trim() + (s.endsWith('.') ? '' : '.'));
                
                formattedProjectPoints.forEach(point => {
                    rightY = checkPageOverflow(rightY);
                    
                    // Small decorative bullet
                    doc.setFillColor(180, 180, 200);
                    doc.circle(rightColStart + 3, rightY - 1.5, 1, 'F');
                    
                    const bulletText = doc.splitTextToSize(point.trim(), rightColWidth - 8);
                    doc.text(bulletText, rightColStart + 7, rightY);
                    rightY += bulletText.length * 4 + 1;
                });
            }
            
            // Project technologies
            if (project.technologies) {
                rightY = checkPageOverflow(rightY);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(8);
                doc.text("Technologies:", rightColStart + 7, rightY);
                
                doc.setFont("helvetica", "normal");
                const techText = Array.isArray(project.technologies) ? 
                    project.technologies.join(", ") : project.technologies;
                
                const techLines = doc.splitTextToSize(techText, rightColWidth - 40);
                doc.text(techLines, rightColStart + 35, rightY);
                rightY += techLines.length * 3 + 2;
            }
            
            // Project link
            if (project.link) {
                rightY = checkPageOverflow(rightY);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0, 102, 204); // Link color
                doc.text(`Link: ${project.link}`, rightColStart + 7, rightY);
                rightY += 5;
            }
            
            rightY += 8; // Space between projects
        });
    }
    
    // Add page numbers
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFont("helvetica", "italic");
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
    }
}
// Handle resume generation button click
$(document).on('click', '.generate-resume-btn', function() {
    const templateId = $(this).closest('.template-preview').data('template');
    const btn = $(this);
    
    // Show loading state
    btn.html('<i class="fas fa-spinner fa-spin"></i> Preparing...');
    btn.prop('disabled', true);
    
    // Fetch user data including experiences and projects
    $.ajax({
        url: '/generate_resume/' + templateId + '/',
        method: 'GET',
        success: function(response) {
            if (response.success) {
                // Get the full user data including experiences and projects
                const userId = "{{ request.user.id }}";
                
                // First get experiences
                $.ajax({
                    url: '/get_experiences/',
                    method: 'GET',
                    data: { user_id: userId },
                    success: function(expResponse) {
                        if (expResponse.success) {
                            // Then get projects
                            $.ajax({
                                url: '/get_projects/',
                                method: 'GET',
                                data: { user_id: userId },
                                success: function(projResponse) {
                                    if (projResponse.success) {
                                        // Combine all data
                                        const fullUserData = {
                                            ...response.data[0],
                                            experiences: expResponse.data,
                                            projects: projResponse.data
                                        };
                                        
                                        // Generate PDF with the complete user data
                                        generateResumeWithJsPDF(templateId, fullUserData);
                                    } else {
                                        alert('Error: Could not fetch projects');
                                    }
                                },
                                error: function() {
                                    alert('Error fetching projects');
                                },
                                complete: function() {
                                    // Reset button state
                                    btn.html('Use Template ' + templateId);
                                    btn.prop('disabled', false);
                                }
                            });
                        } else {
                            alert('Error: Could not fetch experiences');
                        }
                    },
                    error: function() {
                        alert('Error fetching experiences');
                    }
                });
            } else {
                alert('Error: Could not fetch user data');
            }
        },
        error: function(xhr, status, error) {
            alert('Error: ' + error);
            // Reset button state
            btn.html('Use Template ' + templateId);
            btn.prop('disabled', false);
        }
    });
});// Add smooth scrolling to all links
$(document).ready(function(){
    $("a").on('click', function(event) {
        if (this.hash !== "") {
            event.preventDefault();
            var hash = this.hash;
            
            $('html, body').animate({
                scrollTop: $(hash).offset().top - 70
            }, 800, function(){
                window.location.hash = hash;
            });
        }
    });
    
    // Close mobile menu when clicking on a nav link
    $('.navbar-nav>li>a').on('click', function(){
        $('.navbar-collapse').collapse('hide');
    });
});
    </script>
    <script src="{% static 'js/scripthome.js' %}"></script>
    <!-- jsPDF for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
{% endblock %}